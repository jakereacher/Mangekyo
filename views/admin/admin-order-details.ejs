<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order Details - Admin Panel</title>
    <link rel="stylesheet" href="/css/bootstrap.min.css">
    <link rel="stylesheet" href="/css/admin.css">
    <style>
        /* Same as provided CSS */
        body {
            background-color: #f8f9fa;
            font-family: 'Arial', sans-serif;
        }
        .navbar {
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .navbar-brand {
            font-weight: bold;
        }
        .navbar-nav .nav-link {
            padding: 0.5rem 1rem;
            transition: color 0.3s ease;
        }
        .navbar-nav .nav-link:hover {
            color: #ffc107 !important;
        }
        .container {
            max-width: 1200px;
            margin-top: 2rem;
            padding: 0 15px;
        }
        h2.mb-4 {
            color: #343a40;
            font-weight: 600;
            border-bottom: 2px solid #007bff;
            padding-bottom: 0.5rem;
            display: inline-block;
        }
        .card {
            border: none;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 1.5rem;
        }
        .card-header {
            background-color: #007bff;
            color: white;
            font-weight: 500;
            border-radius: 8px 8px 0 0;
            padding: 1rem;
        }
        .card-body {
            padding: 1.5rem;
        }
        .table {
            background-color: #fff;
            border-radius: 8px;
            overflow: hidden;
        }
        .table thead th {
            background-color: #f1f3f5;
            color: #343a40;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.85rem;
            padding: 1rem;
        }
        .table tbody tr {
            transition: background-color 0.2s ease;
        }
        .table tbody tr:hover {
            background-color: #f8f9fa;
        }
        .table td, .table th {
            vertical-align: middle;
            padding: 0.75rem;
        }
        .table img {
            border-radius: 4px;
            object-fit: cover;
        }
        .form-select, .form-control {
            padding: 0.5rem;
            font-size: 0.9rem;
            border-radius: 4px;
            border: 1px solid #ced4da;
            transition: border-color 0.3s ease;
        }
        .form-select:focus, .form-control:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }
        .form-select:disabled, .form-control:disabled {
            background-color: #e9ecef;
            cursor: not-allowed;
        }
        .card-body p {
            margin-bottom: 0.75rem;
            font-size: 0.95rem;
        }
        .card-body p strong {
            color: #343a40;
            min-width: 120px;
            display: inline-block;
        }
        address {
            font-style: normal;
            line-height: 1.6;
            color: #6c757d;
        }
        footer {
            position: relative;
            bottom: 0;
            width: 100%;
            padding: 1rem 0;
            background-color: #343a40;
            color: #fff;
            font-size: 0.9rem;
        }
        .return-info {
            margin-top: 0.5rem;
            padding: 0.5rem;
            background-color: #f8f9fa;
            border-radius: 4px;
        }
        .return-info p {
            margin: 0;
            font-size: 0.9rem;
        }
        .btn-sm {
            font-size: 0.85rem;
        }
        @media (max-width: 768px) {
            .container {
                padding: 0 10px;
            }
            .card-header h5 {
                font-size: 1.1rem;
            }
            .table {
                font-size: 0.85rem;
            }
            .form-select, .form-control {
                width: 100%;
            }
            .card-body p strong {
                min-width: 100px;
            }
            .navbar-nav .nav-link {
                padding: 0.5rem;
            }
        }
        @media (max-width: 576px) {
            h2.mb-4 {
                font-size: 1.5rem;
            }
            .table thead th {
                font-size: 0.75rem;
            }
            .table td, .table th {
                padding: 0.5rem;
            }
            .form-select, .form-control {
                width: 100%;
            }
            .card-body p {
                font-size: 0.85rem;
            }
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/admin/dashboard">Admin Panel</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/orders">Orders</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/products">Products</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/users">Users</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/return-requests">Return Requests</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/logout">Logout</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container mt-5">
        <h2 class="mb-4">Order Details</h2>

        <!-- Order Summary -->
        <div class="card mb-4">
            <div class="card-header">
                <h5>Order #<%= order._id %> - <%= order.status %></h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Customer:</strong> <%= order.userName %> (<%= order.userEmail %>)</p>
                        <p><strong>Order Date:</strong> <%= order.formattedOrderDate %></p>
                        <p><strong>Delivery Date:</strong> <%= order.formattedDeliveryDate %></p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Payment Method:</strong> <%= order.paymentMethod %></p>
                        <p><strong>Payment Status:</strong> <%= order.paymentStatus %></p>
                        <p><strong>Shipping Address:</strong></p>
                        <address>
                            <%= order.shippingAddress.addressLine1 %><br>
                            <%= order.shippingAddress.addressLine2 ? order.shippingAddress.addressLine2 + '<br>' : '' %>
                            <%= order.shippingAddress.city %>, <%= order.shippingAddress.state %> <%= order.shippingAddress.postalCode %><br>
                            <%= order.shippingAddress.country %>
                        </address>
                    </div>
                </div>
            </div>
        </div>

        <!-- Order Items -->
        <div class="card mb-4">
            <div class="card-header">
                <h5>Order Items</h5>
            </div>
            <div class="card-body">
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th>Product</th>
                            <th>Image</th>
                            <th>Quantity</th>
                            <th>Price</th>
                            <th>Total</th>
                            <th>Status</th>
                            <th>Update Status</th>
                            <th>Return Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% order.items.forEach(item => { %>
                            <tr data-product-id="<%= item.product._id %>">
                                <td><%= item.product.productName %></td>
                                <td>
                                    <img src="<%= item.product.mainImage %>" alt="<%= item.product.productName %>" style="width: 50px; height: auto;">
                                </td>
                                <td><%= item.quantity %></td>
                                <td>$<%= item.price.toFixed(2) %></td>
                                <td>$<%= item.totalPrice %></td>
                                <td class="status-cell"><%= item.status %></td>
                                <td>
                                    <select class="form-select status-select" data-product-id="<%= item.product._id %>" <%= item.order_return_status === 'Pending' || item.order_return_status === 'Approved' || item.order_return_status === 'Rejected' ? 'disabled' : '' %>>
                                        <option value="Processing" <%= item.status === 'Processing' ? 'selected' : '' %>>Processing</option>
                                        <option value="Shipped" <%= item.status === 'Shipped' ? 'selected' : '' %>>Shipped</option>
                                        <option value="Delivered" <%= item.status === 'Delivered' ? 'selected' : '' %>>Delivered</option>
                                        <option value="Cancelled" <%= item.status === 'Cancelled' ? 'selected' : '' %>>Cancelled</option>
                                    </select>
                                </td>
                                <td>
                                    <% if (item.order_return_status === 'Pending') { %>
                                        <div class="return-info">
                                            <p><strong>Return Reason:</strong> <%= item.returnReason %></p>
                                            <p><strong>Requested:</strong> <%= new Date(item.order_return_request_date).toLocaleDateString() %></p>
                                            <form action="/admin/orders/<%= order._id %>/approve-return" method="POST" class="d-inline return-form" data-action="approve">
                                                <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                                                <input type="hidden" name="orderId" value="<%= order._id %>">
                                                <input type="hidden" name="productId" value="<%= item.product._id %>">
                                                <button type="submit" class="btn btn-success btn-sm">Approve</button>
                                            </form>
                                            <form action="/admin/orders/<%= order._id %>/reject-return" method="POST" class="d-inline return-form" data-action="reject">
                                                <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                                                <input type="hidden" name="orderId" value="<%= order._id %>">
                                                <input type="hidden" name="productId" value="<%= item.product._id %>">
                                                <input type="text" name="adminResponse" class="form-control d-inline w-auto" placeholder="Rejection reason" required>
                                                <button type="submit" class="btn btn-danger btn-sm">Reject</button>
                                            </form>
                                        </div>
                                    <% } else if (item.order_return_status === 'Approved') { %>
                                        <div class="return-info">
                                            <p>Return Approved on <%= new Date(item.order_returned_date).toLocaleDateString() %></p>
                                        </div>
                                    <% } else if (item.order_return_status === 'Rejected') { %>
                                        <div class="return-info">
                                            <p>Return Rejected: <%= item.adminResponse %></p>
                                        </div>
                                    <% } else { %>
                                        <p>No return requested</p>
                                    <% } %>
                                </td>
                            </tr>
                        <% }) %>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Order Totals -->
        <div class="card">
            <div class="card-header">
                <h5>Order Totals</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 offset-md-6">
                        <p><strong>Subtotal:</strong> $<%= order.subtotal %></p>
                        <p><strong>Shipping:</strong> $<%= order.shipping %></p>
                        <p><strong>Tax:</strong> $<%= order.tax %></p>
                        <hr>
                        <p><strong>Total:</strong> $<%= order.total %></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Success Modal -->
    <div class="modal fade" id="successModal" tabindex="-1" aria-labelledby="successModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="successModalLabel">Success</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    The action was completed successfully.
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">OK</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Error Modal -->
    <div class="modal fade" id="errorModal" tabindex="-1" aria-labelledby="errorModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="errorModalLabel">Error</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    An error occurred.
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-dark text-white text-center py-3 mt-5">
        <p>© 2025 Admin Panel. All rights reserved.</p>
    </footer>

    <!-- Scripts -->
    <script src="/js/bootstrap.bundle.min.js"></script>
    <script>
        // Status Update Handler
        document.querySelectorAll('.status-select').forEach(select => {
            select.addEventListener('change', async (e) => {
                const selectElement = e.target;
                const productId = selectElement.dataset.productId;
                const status = selectElement.value;
                const orderId = '<%= order._id %>';

                // Disable select to prevent multiple submissions
                selectElement.disabled = true;

                try {
                    const response = await fetch(`/admin/orders/${orderId}/update-status`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRF-Token': '<%= csrfToken %>'
                        },
                        body: JSON.stringify({ productId, status })
                    });

                    const result = await response.json();

                    if (result.success) {
                        // Update status in the table
                        const row = selectElement.closest('tr');
                        row.querySelector('.status-cell').textContent = status;

                        // Show success modal
                        const successModal = new bootstrap.Modal(document.getElementById('successModal'));
                        document.querySelector('#successModal .modal-body').textContent = 'The item status has been updated successfully.';
                        successModal.show();
                    } else {
                        // Show error modal with message
                        const errorModal = new bootstrap.Modal(document.getElementById('errorModal'));
                        document.querySelector('#errorModal .modal-body').textContent = result.message || 'Failed to update item status.';
                        errorModal.show();

                        // Revert select to original value
                        const originalStatus = row.querySelector('.status-cell').textContent;
                        selectElement.value = originalStatus;
                    }
                } catch (error) {
                    // Show error modal
                    const errorModal = new bootstrap.Modal(document.getElementById('errorModal'));
                    document.querySelector('#errorModal .modal-body').textContent = 'Error updating status: ' + error.message;
                    errorModal.show();

                    // Revert select to original value
                    const originalStatus = selectElement.closest('tr').querySelector('.status-cell').textContent;
                    selectElement.value = originalStatus;
                } finally {
                    // Re-enable select
                    selectElement.disabled = false;
                }
            });
        });

        // Return Request Handler
        document.querySelectorAll('.return-form').forEach(form => {
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const formElement = e.target;
                const action = formElement.dataset.action;
                const orderId = formElement.querySelector('input[name="orderId"]').value;
                const productId = formElement.querySelector('input[name="productId"]').value;
                const adminResponse = formElement.querySelector('input[name="adminResponse"]')?.value;

                // Disable form buttons to prevent multiple submissions
                const buttons = formElement.querySelectorAll('button');
                buttons.forEach(btn => btn.disabled = true);

                try {
                    const response = await fetch(`/admin/orders/${orderId}/${action}-return`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRF-Token': '<%= csrfToken %>'
                        },
                        body: JSON.stringify({ orderId, productId, adminResponse })
                    });

                    const result = await response.json();

                    if (result.success) {
                        // Update return status in the table
                        const row = formElement.closest('tr');
                        const returnCell = row.querySelector('td:last-child');
                        if (action === 'approve') {
                            returnCell.innerHTML = `<div class="return-info"><p>Return Approved on ${new Date().toLocaleDateString()}</p></div>`;
                        } else {
                            returnCell.innerHTML = `<div class="return-info"><p>Return Rejected: ${adminResponse}</p></div>`;
                        }

                        // Disable status select
                        row.querySelector('.status-select').disabled = true;

                        // Show success modal
                        const successModal = new bootstrap.Modal(document.getElementById('successModal'));
                        document.querySelector('#successModal .modal-body').textContent = `Return ${action === 'approve' ? 'approved and wallet credited' : 'rejected'} successfully.`;
                        successModal.show();
                    } else {
                        // Show error modal
                        const errorModal = new bootstrap.Modal(document.getElementById('errorModal'));
                        document.querySelector('#errorModal .modal-body').textContent = result.message || `Failed to ${action} return.`;
                        errorModal.show();
                    }
                } catch (error) {
                    // Show error modal
                    const errorModal = new bootstrap.Modal(document.getElementById('errorModal'));
                    document.querySelector('#errorModal .modal-body').textContent = `Error ${action === 'approve' ? 'approving' : 'rejecting'} return: ${error.message}`;
                    errorModal.show();
                } finally {
                    // Re-enable buttons
                    buttons.forEach(btn => btn.disabled = false);
                }
            });
        });
    </script>
</body>
</html>